<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_title }}</title>
    <script src="/static/tailwindcss.js"></script>
    <style>
        .status-active {
            background-color: #10b981;
        }
        .status-expiring {
            background-color: #f59e0b;
        }
        .status-expired {
            background-color: #ef4444;
        }
    </style>
</head>
<body class="bg-neutral-950 text-white">
    <div class="flex min-h-screen">
        {% include 'sidebar.html' %}
        
        <main class="flex-1 p-8 lg:ml-0">
            <div class="max-w-full">
                <div class="mb-8">
                    <h1 class="text-4xl font-bold text-orange-500 mb-2">üìú Certificate List</h1>
                    <p class="text-gray-400">View all certificates stored in Azure Blob Storage</p>
                </div>

                <div id="loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div>
                    <p class="mt-4 text-gray-400">Loading certificates...</p>
                </div>

                <div id="error" class="hidden bg-red-900 border border-red-700 text-red-200 px-6 py-4 rounded-lg mb-6">
                    <h3 class="font-bold mb-2">‚ùå Error</h3>
                    <p id="error-message"></p>
                </div>

                <div id="no-certs" class="hidden bg-blue-900 border border-blue-700 text-blue-200 px-6 py-4 rounded-lg mb-6">
                    <h3 class="font-bold mb-2">‚ÑπÔ∏è No Certificates Found</h3>
                    <p>No certificates found in Azure Blob Storage. Sign a CSR with Azure Key Vault to create certificates.</p>
                </div>

                <div id="ca-filter" class="hidden mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Filter by CA Directory:</label>
                    <select id="ca-select" class="bg-neutral-800 border border-neutral-700 text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent" onchange="filterByCA()">
                        <option value="">All CAs</option>
                    </select>
                </div>

                <div id="cert-stats" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-neutral-800 border border-neutral-700 rounded-lg p-4">
                        <div class="text-gray-400 text-sm">Total Certificates</div>
                        <div class="text-2xl font-bold text-white" id="stat-total">0</div>
                    </div>
                    <div class="bg-neutral-800 border border-neutral-700 rounded-lg p-4">
                        <div class="text-gray-400 text-sm">Active</div>
                        <div class="text-2xl font-bold text-green-500" id="stat-active">0</div>
                    </div>
                    <div class="bg-neutral-800 border border-neutral-700 rounded-lg p-4">
                        <div class="text-gray-400 text-sm">Expiring Soon (30d)</div>
                        <div class="text-2xl font-bold text-yellow-500" id="stat-expiring">0</div>
                    </div>
                    <div class="bg-neutral-800 border border-neutral-700 rounded-lg p-4">
                        <div class="text-gray-400 text-sm">Expired</div>
                        <div class="text-2xl font-bold text-red-500" id="stat-expired">0</div>
                    </div>
                </div>

                <div id="certificates" class="hidden">
                    <div class="bg-neutral-900 border border-neutral-700 rounded-lg shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-neutral-700">
                                <thead class="bg-neutral-800">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">CA Directory</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Common Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Issuer</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Valid From</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Expires</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Days Left</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">File Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="cert-table-body" class="bg-neutral-900 divide-y divide-neutral-700">
                                    <!-- Table rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let allCertificates = [];
        let caDirectories = [];

        // Load certificates on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCertificates();
        });

        function filterByCA() {
            const select = document.getElementById('ca-select');
            const caFilter = select.value || null;
            
            // Show loading
            document.getElementById('certificates').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            
            loadCertificates(caFilter);
        }

        async function loadCertificates(caFilter = null) {
            try {
                const response = await fetch('/list-certificates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ca_filter: caFilter })
                });

                const data = await response.json();

                // Hide loading
                document.getElementById('loading').classList.add('hidden');

                if (!response.ok) {
                    showError(data.error || 'Failed to load certificates');
                    return;
                }

                if (!data.certificates || data.certificates.length === 0) {
                    document.getElementById('no-certs').classList.remove('hidden');
                    return;
                }

                // Store data
                allCertificates = data.certificates;
                caDirectories = data.ca_directories || [];

                // Populate CA filter dropdown (only on first load)
                if (caDirectories.length > 0 && !caFilter) {
                    const select = document.getElementById('ca-select');
                    select.innerHTML = '<option value="">All CAs</option>';
                    caDirectories.forEach(ca => {
                        const option = document.createElement('option');
                        option.value = ca;
                        option.textContent = ca;
                        select.appendChild(option);
                    });
                    document.getElementById('ca-filter').classList.remove('hidden');
                }

                // Hide loading
                document.getElementById('loading').classList.add('hidden');

                if (!response.ok) {
                    showError(data.error || 'Failed to load certificates');
                    return;
                }

                if (!data.certificates || data.certificates.length === 0) {
                    document.getElementById('no-certs').classList.remove('hidden');
                    return;
                }

                // Calculate statistics
                const now = new Date();
                const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                
                let stats = {
                    total: data.certificates.length,
                    active: 0,
                    expiring: 0,
                    expired: 0
                };

                data.certificates.forEach(cert => {
                    const expiryDate = new Date(cert.not_after);
                    if (expiryDate < now) {
                        stats.expired++;
                    } else if (expiryDate < thirtyDaysFromNow) {
                        stats.expiring++;
                    } else {
                        stats.active++;
                    }
                });

                // Update stats
                document.getElementById('stat-total').textContent = stats.total;
                document.getElementById('stat-active').textContent = stats.active;
                document.getElementById('stat-expiring').textContent = stats.expiring;
                document.getElementById('stat-expired').textContent = stats.expired;
                document.getElementById('cert-stats').classList.remove('hidden');

                // Build table
                const tbody = document.getElementById('cert-table-body');
                tbody.innerHTML = '';

                data.certificates.forEach(cert => {
                    const row = createCertificateRow(cert);
                    tbody.appendChild(row);
                });

                document.getElementById('certificates').classList.remove('hidden');

            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                showError('Failed to load certificates: ' + error.message);
            }
        }

        function createCertificateRow(cert) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-neutral-800 transition-colors';

            const now = new Date();
            const expiryDate = new Date(cert.not_after);
            const validFromDate = new Date(cert.not_before);
            const daysLeft = Math.floor((expiryDate - now) / (1000 * 60 * 60 * 24));
            
            let status, statusClass, statusText;
            if (daysLeft < 0) {
                status = 'Expired';
                statusClass = 'status-expired';
                statusText = 'EXPIRED';
            } else if (daysLeft < 30) {
                status = 'Expiring Soon';
                statusClass = 'status-expiring';
                statusText = 'EXPIRING';
            } else {
                status = 'Active';
                statusClass = 'status-active';
                statusText = 'ACTIVE';
            }

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="${statusClass} text-white text-xs font-semibold px-2 py-1 rounded">${statusText}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-400 font-semibold">${escapeHtml(cert.ca_directory)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${escapeHtml(cert.common_name)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${escapeHtml(cert.issuer)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${formatDate(validFromDate)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${formatDate(expiryDate)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${daysLeft < 0 ? 'text-red-500' : daysLeft < 30 ? 'text-yellow-500' : 'text-green-500'} font-semibold">
                    ${daysLeft < 0 ? 'Expired' : `${daysLeft} days`}
                </td>
                <td class="px-6 py-4 text-sm text-gray-400 font-mono text-xs max-w-xs truncate" title="${escapeHtml(cert.name)}">${escapeHtml(cert.name)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <a href="${escapeHtml(cert.url)}" target="_blank" class="text-blue-500 hover:text-blue-400 mr-3" title="Download">
                        ‚¨áÔ∏è Download
                    </a>
                </td>
            `;

            return row;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error').classList.remove('hidden');
        }
    </script>
</body>
</html>
